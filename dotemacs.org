# -*- ispell-local-dictionary: "en_US" -*-
#+TITLE:My Emacs Literate Config
#+AUTHOR: L. Gualdi
#+LANGUAGE: en
#+PROPERTY: header-args :tangle "~/.emacs.d/init.el"  :exports code

* early-init.el
#+begin_src elisp :tangle "~/.emacs.d/early-init.el"  :exports code
  ;;; early-init.el --- Initialization file for Emacs -*- lexical-binding: t; -*-
  ;;; Commentary:
  ;;  Emacs early init Startup File --- initialization for Emacs
  ;;  Do not edit this file directly, use dotemacs.org instead and tangle code using 'C-c C-v t'.

  ;;; Code:

  (require 'package)
  (package-initialize)

  (add-to-list 'package-archives
    	     '("melpa" . "https://melpa.org/packages/"))

  ;; https://github.com/jamescherti/minimal-emacs.d
  (defvar minimal-emacs-gc-cons-threshold (* 16 1024 1024)
    "The value of `gc-cons-threshold' after Emacs startup.")

  ;;; Garbage collection
  ;; Garbage collection significantly affects startup times. This setting delays
  ;; garbage collection during startup but will be reset later.

  (setq gc-cons-threshold most-positive-fixnum)

  (add-hook 'emacs-startup-hook
            (lambda ()
              (setq gc-cons-threshold minimal-emacs-gc-cons-threshold)))

  ;;; Performance
  ;; Set environment variable to speed up lsp-mode
  ;; check https://emacs-lsp.github.io/lsp-mode/page/performance/
  (setenv "LSP_USE_PLISTS" "true")

  ;; Prefer loading newer compiled files
  (setq load-prefer-newer t)

  ;; Font compacting can be very resource-intensive, especially when rendering
  ;; icon fonts on Windows. This will increase memory usage.
  (setq inhibit-compacting-font-caches t)

  (provide 'early-init)
  ;;; early-init.el ends here
#+end_src


* init.el
** Header
#+begin_src elisp
  ;;; init.el --- Initialization file for Emacs -*- lexical-binding: t; -*-
  ;;; Commentary:
  ;;  Emacs Startup File --- initialization for Emacs
  ;;  Do not edit this file directly, use dotemacs.org instead and tangle code using 'C-c C-v t'.

  ;;; Code:
#+end_src

** Customized settings
It's possible to configure Emacs settings via =M-x customize=. By default, the
customized settings are stored in the 'user-init-file'. Store customized
settings in =custom.el= instead of =init.el=.
#+begin_src elisp
  (setopt custom-file (expand-file-name "custom.el" user-emacs-directory))
  (if (file-exists-p custom-file)
      (load custom-file))
#+end_src

** User's personal settings

Load personal's settings such as name or current email from another file
#+begin_src elisp
  (let ((file-path (expand-file-name ".work/settings.el" user-emacs-directory)))
    (when (file-exists-p file-path)
      (load file-path)))

  (let ((file-path (expand-file-name ".home/settings.el" user-emacs-directory)))
    (when (file-exists-p file-path)
      (load file-path)))
#+end_src

Load my personal lisp module stored in "elisp" directory

#+begin_src elisp
  (add-to-list 'load-path
               (expand-file-name "elisp" user-emacs-directory))
  (load "lg-lisp")
  (load "my-org-outlook")
  (load "my-emacs-skeleton")
#+end_src

** Default settings
#+begin_src elisp
  ;; Disable all backup files
  (setopt make-backup-files nil)

  ;; Use short answer by default
  (setopt use-short-answers t)

  ;; Set default enconding system to utf-8
  (set-language-environment 'utf-8)
  (set-default-coding-systems 'utf-8)

  ;; Delete the current selection
  (delete-selection-mode t)

  ;; Disable scroll bar, menu bar, etc.
  (tool-bar-mode -1)
  (scroll-bar-mode -1)

  ;; Hide menu bar except on macosx
  (unless (memq window-system '(mac ns))
    (menu-bar-mode -1))

  ;; Inihibit startup screen
  (setopt inhibit-startup-screen t)

  ;; Use single space to end sentence
  (setopt sentence-end-double-space nil)

  ;; Change auto-fill width
  (setq-default fill-column 80)

  ;; Use space instead of tab
  (setq-default indent-tabs-mode nil)

  ;; Change default tab width
  (setq-default tab-width 2)
  (setq-default js-indent-level 2)
  (setq-default css-indent-offset 2)

  ;; Add hook to display line number in prog-mode
  (add-hook 'prog-mode-hook 'display-line-numbers-mode)
  (add-hook 'prog-mode-hook 'hl-line-mode)

  ;; By default, Emacs "updates" its ui more often than it needs to
  (setq idle-update-delay 1.0)

  ;; Increase how much is read from processes in a single chunk
  (setq read-process-output-max (* 512 1024))  ; 512kb

  ;;; Auto revert
  ;; Auto-revert in Emacs is a feature that automatically updates the
  ;; contents of a buffer to reflect changes made to the underlying file
  ;; on disk.
  (setq revert-without-query (list ".")  ; Do not prompt
        auto-revert-stop-on-user-input nil
        auto-revert-verbose t)

  ;; Revert other buffers (e.g, Dired)
  (setq global-auto-revert-non-file-buffers t)

  ;; Activate smooth scrolling
  (pixel-scroll-precision-mode)

  ;; Tips found on reddit /r/emacs to speeds up org files opening on windows after first emacs startup
  ;; https://www.reddit.com/r/emacs/comments/c2qddk/comment/ermm3tc/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button
  ;; The effect of the following line is to load org the first time you do nothing for a second.
  ;; The second argument nil means that this only happens once.

  (run-with-idle-timer 1 nil (lambda () (require 'org)))
#+end_src

When the help window appears on another frame, then give that frame input focus
too.
#+begin_src emacs-lisp
  (setopt help-window-select t)
#+end_src

Add a hook to delete all trailing white space before saving.

Note : ~#'~ syntax is a short-hand for using 'function'. 'function' is like 'quote' but
preferred for objects which are functions (see Emacs lisp manual).

#+begin_src elisp
  (add-hook 'before-save-hook #'delete-trailing-whitespace)
#+end_src

Enable mode to save list of recently opened files.
#+begin_src elisp
  (recentf-mode t)
#+end_src

Save cursor position between Emacs sessions.
#+begin_src elisp
  (save-place-mode t)
#+end_src

Save history
#+begin_src elisp
  ;; Persist history over Emacs restarts.
  (use-package savehist
    :custom
    (history-delete-duplicates t)

    :init
    (savehist-mode))
#+end_src


** Macosx related settings
*** Keyboard
I'm using a mac with a french keyboard layout. Some characters cannot be used
directly.

#+begin_src elisp
  (defvar mac-command-modifier)
  (defvar mac-option-modifier)
  (defvar mac-control-modifier)
  (defvar ns-function-modifier)

  (if (memq window-system '(mac ns))
      (progn
        ;; Remap <home> and <end> to beginning-of-line and end-of-line
        ;; instead of  beginning-of-buffer and end-of-buffer
        (keymap-global-set "<home>" 'beginning-of-line)
        (keymap-global-set "<end>" 'end-of-line)

        (setq mac-command-modifier 'meta)  ;; enable meta as command
        (setq mac-option-modifier 'none) ;; Disable option key to be able to input special characters like pipe or tilde on french keyboard
        (setq mac-control-modifier 'control) ;; Enable control
        (setq ns-function-modifier 'super)  ;; make Fn key do Super
        (setq default-input-method "MacOSX")))
#+end_src

*** Frame title bar follow Macosx theme
#+begin_src elisp
  (if (memq window-system '(mac ns))
      (progn
        (defvar ns-use-proxy-icon)
        (add-to-list 'default-frame-alist '(ns-transparent-titlebar . t))
        (add-to-list 'default-frame-alist '(ns-appearance . dark))
        (setq ns-use-proxy-icon  nil)))
#+end_src

** Emacs Appearance
*** Themes
#+begin_src elisp
  ;; (load-theme 'tango-plus t)
  (use-package ef-themes
    :ensure t
    :config
    ;; All customisations here.
    ;; Finally, load your theme of choice (or a random one with
    ;; `modus-themes-load-random', `modus-themes-load-random-dark',
    ;; `modus-themes-load-random-light').
    (modus-themes-load-theme 'ef-cyprus))
#+end_src

*** Fonts
Use the Iosevka font for code and prose.
Use function from [[https://jeffkreeftmeijer.com/emacs-configuration/][Jeff Kreeftmeijer]] init.el
#+begin_src elisp
  (defun jk/set-face-font (face family)
    (set-face-attribute
     face nil
     :family family :weight 'regular :width 'expanded :height 100))

  (jk/set-face-font 'default "Iosevka")
  (jk/set-face-font 'fixed-pitch "Iosevka")
  (jk/set-face-font 'variable-pitch "Iosevka Aile")


  ;; Use a hook to use variable pitch font in text-mode
  (add-hook 'text-mode-hook #'variable-pitch-mode)
#+end_src


** Packages settings
Package repository declaration and package initialization is done in =early-init.el=.

*** exec-path-from-shell
On Macosx, when Emacs instance is launched as a GUI app, it inherits a default
minimal set of environment variable. This package ensure environment variable
inside Emacs look the same as in the user's path.

#+begin_src elisp
  (use-package exec-path-from-shell
    :if (memq window-system '(mac ns))
    :ensure t
    :config
    (exec-path-from-shell-initialize))
#+end_src

*** Spellchecking
I spent a lot of time trying to setup spellchecking within Emacs. I don't know
if this is the right way to do it, but with trials and errors, i was able to find a
workable enough setup for my needs.

On Macosx, I'm using Aspell because it was the easiest one to setup.
Aspell can be install via [[https://brew.sh/][homebrew]].

#+begin_src sh :tangle no
  $ brew install aspell
#+end_src

On windows, I'm using Hunspell. Hunspell can be install with [[https://chocolatey.org/][chocolatey]] package manager.

#+begin_src sh :tangle no
  choco install hunspell
#+end_src

In order to make Hunspell work on windows, create a directory =C:/hunspell=.
Then copy all *.aff and *.dic files that you need in this directory. I copied
mine from the [[https://github.com/LibreOffice/dictionaries][LibreOffice dictionaries]] repo on GitHub.

Then you must initialize =ispell-hunspell-dict-paths-alist= with all the
dictionary that you want to use.

At runtime, Emacs setup automatically the variable ~ispell-program-name~ to correct path
depending of your current spellchecker.

To switch between dictionary, you just have to use ~M-x
ispell-change-dictionary~ and select one of the dictionary initialized in =ispell-hunspell-dict-paths-alist=.

I also setup a personal dictionary using =ispell-personal-dictionary=. it must
be an absolute file name and the file must already exist for Hunspell to be able
to use it.

It's also possible to setup ispell dictionary on a per file basis if you specify
=ispell-local-dictionary= value in the first line of the file (see [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Specifying-File-Variables.html][Specifying File Variable]]).

#+begin_example
-*- ispell-local-dictionary: "en_US" -*-
#+end_example



#+begin_src elisp
  (use-package ispell
    :defer t
    :config

    ;; Set the default dictionary to french
    (setenv "DICTIONARY" "fr")
    (setopt ispell-dictionary "fr")
    (setopt ispell-current-dictionary "fr")

    ;; Setup all dictionary path to use only on windows
    (when (memq window-system '(w32))
      (setopt
       ispell-hunspell-dict-paths-alist
       '(("fr" "C:/Hunspell/fr.aff")
         ("en_GB" "C:/Hunspell/en_GB.aff")
         ("en_US" "C:/Hunspell/en_US.aff")
         )))

    ;; Create a personal dictionary if it doesn't exist.
    (let ((filename (expand-file-name "perso.dic" user-emacs-directory)))
      (unless (file-exists-p filename)
        (with-temp-buffer
          (write-file filename))))

    ;; Ignore file sections for spell checking.
    (add-to-list 'ispell-skip-region-alist '("#\\+begin_example" . "#\\+end_example"))
    (add-to-list 'ispell-skip-region-alist '("#\\+begin_src" . "#\\+end_src"))
    (add-to-list 'ispell-skip-region-alist '("\\$" . "\\$"))
    (add-to-list 'ispell-skip-region-alist '(org-property-drawer-re))
    (add-to-list 'ispell-skip-region-alist '(":\\(PROPERTIES\\|LOGBOOK\\):" . ":END:"))

    :custom
    ;; There is a bug in corfu  [[https://github.com/minad/corfu/discussions/457][#457]]
    ;; Error running timer ‘corfu--auto-complete-deferred’: (error "ispell-lookup-words: No plain word-list found at systemdefault locations.  Customize ‘ispell-alternate-dictionary’ to set yours.")
    ;; a workaround is to set this variable to nil
    (text-mode-ispell-word-completion nil)

    ;; Setup the personal dictionary path
    (ispell-personal-dictionary
     (expand-file-name "perso.dic" user-emacs-directory)))
#+end_src

**** Flyspell
Enable Flyspell in text-mode derived buffer.

#+begin_src elisp
  (use-package flyspell
    :defer t
    :bind
    (:map flyspell-mouse-map
          ("<down-mouse-3>" . flyspell-correct-word)
          ("<mouse-3>" . undefined))
    :hook
    (text-mode . flyspell-mode))
#+end_src

**** Flycheck-grammalect
This enable =flycheck-grammalect= for french grammar and typography check.
The current version in melpa needs pkg-info.

#+begin_src elisp
  (use-package pkg-info
    :ensure t)
#+end_src

To use this package, you need to download the [[https://grammalecte.net/#download][Grammalect CLI & Server upstream]]
package. Just enter the following command: ~M-x grammalecte-download-grammalecte~.
Grammalect command line and server needs =Python 3.5+= our =Python 3.7+= to run.

#+begin_src elisp
  (use-package flycheck-grammalecte
    :ensure t
    :demand t ; force package to load immediately

    :hook
    (text-mode . flycheck-mode)

    :init
    (setq flycheck-grammalecte-report-apos nil
          flycheck-grammalecte-report-typo nil
          flycheck-grammalecte-report-esp nil
          flycheck-grammalecte-report-nbsp nil)

    ;; enable grammalect only in french org-mode buffers
    (setq flycheck-grammalecte-predicate
          (lambda ()
            (or (and (derived-mode-p 'org-mode)
                     (equal "fr"
                            (or (cadar (org-collect-keywords '("LANGUAGE")))
                                (bound-and-true-p
                                  org-export-default-language))))
                (and (boundp 'ispell-local-dictionary)
                     (member ispell-local-dictionary
                             '("fr" "francais7" "francais-tex"))))))

    :config
    ;; (grammalecte-download-grammalecte)   ;
    (flycheck-grammalecte-setup))
#+end_src

*** Plantuml
#+begin_src elisp :tangle no
  (use-package plantuml-mode
    :ensure nil
    :defer t
    :config
    (setq plantuml-output-type "png")
    :custom

    (plantuml-default-exec-mode 'jar)
    (plantuml-options "-charset UTF-8")
    (org-plantuml-jar-path "C:/Program Files/PlantUML/plantuml.jar")
    (plantuml-jar-path "C:/Program Files/PlantUML/plantuml.jar"))
#+end_src

*** SSH
#+begin_src emacs-lisp
  (use-package ssh-agency
    :ensure t)

  (setenv "SSH_ASKPASS" "git-gui--askpass")
#+end_src

*** Magit
#+begin_src elisp
  (use-package magit
    :ensure t
    :defer t
    :bind ("C-x g" . magit-status))
#+end_src

*** All-the-icons/Nerd Icons

#+begin_src elisp :tangle no
  (use-package all-the-icons
    :if (display-graphic-p))
#+end_src

#+begin_src elisp
  (use-package nerd-icons
    :custom
  ;; The Nerd Font you want to use in GUI
  ;; "Symbols Nerd Font Mono" is the default and is recommended
  ;; but you can use any other Nerd Font if you want
   (nerd-icons-font-family "Symbols Nerd Font Mono")
  )
#+end_src

#+begin_src elisp
  (use-package nerd-icons-dired
    :hook
    (dired-mode . nerd-icons-dired-mode))
#+end_src


#+begin_src elisp
  ;; (use-package emojify
  ;;   :config
  ;;   (when (member "Segoe UI Emoji" (font-family-list))
  ;;     (set-fontset-font
  ;;      t 'symbol (font-spec :family "Segoe UI Emoji") nil 'prepend))
  ;;   (setq emojify-display-style 'unicode)
  ;;   (setq emojify-emoji-styles '(unicode))
  ;;   ;; (bind-key* (kbd "C-c .") #'emojify-insert-emoji)) ; override binding in any mode


  ;;   :hook (after-init . global-emojify-mode))

  (use-package emojify
    :hook (after-init . global-emojify-mode))
#+end_src

*** Spacious padding
#+begin_src elisp
  (use-package spacious-padding
    :ensure t
    :init
    (spacious-padding-mode))
#+end_src

*** doom-modeline
#+begin_src elisp
  (use-package doom-modeline
  :ensure t
  :init (doom-modeline-mode 1))
#+end_src

*** Vertico
#+begin_src elisp
  (use-package vertico
    :ensure t
    :init
    (vertico-mode))
#+end_src

*** Corfu

I used some code from [[https://kristofferbalintona.me/posts/202202270056/][Kristoffer Balintona]] blog to enable corfu instead of company.

#+begin_src elisp
  ;; Setup lsp to use corfu for lsp completion
  (defun kb/corfu-setup-lsp ()
    "Use orderless completion style with lsp-capf instead of the
    default lsp-passthrough."
    (setf (alist-get 'styles (alist-get 'lsp-capf completion-category-defaults))
          '(orderless)))

  (use-package corfu
    :ensure t
    ;; Optional customizations
    ;; :hook (lsp-completion-mode . kb/corfu-setup-lsp) ; Use corfu for lsp completion
    :custom
    (corfu-auto t) ;; Enable corfu autocompletion
    ;; (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
    ;; (corfu-quit-at-boundary nil)   ;; Never quit at completion boundary
    ;; (corfu-quit-no-match nil)      ;; Never quit, even if there is no match
    ;; (corfu-preview-current nil)    ;; Disable current candidate preview
    ;; (corfu-preselect 'prompt)      ;; Preselect the prompt
    ;; (corfu-on-exact-match nil)     ;; Configure handling of exact matches

    ;; Enable Corfu only for certain modes. See also `global-corfu-modes'.
    ;; :hook ((prog-mode . corfu-mode)
    ;; 	  (shell-mode . corfu-mode)
    ;; 	  (eshell-mode . corfu-mode))

    ;; Recommended: Enable Corfu globally.  This is recommended since Dabbrev can
    ;; be used globally (M-/).  See also the customization variable
    ;; `global-corfu-modes' to exclude certain modes.
    :init
    (global-corfu-mode)
    :config
    (keymap-unset corfu-map "RET"))
#+end_src

*** Cape
Completion at point extensions to be used in combination with =corfu=.
#+begin_src elisp
  (use-package cape
    :ensure t
    ;; Bind prefix keymap providing all Cape commands under a mnemonic key.
    ;; Press C-c p ? to for help.
    :bind ("C-c p" . cape-prefix-map) ;; Alternative key: M-<tab>, M-p, M-+
    ;; Alternatively bind Cape commands individually.
    ;; :bind (("C-c p d" . cape-dabbrev)
    ;;        ("C-c p h" . cape-history)
    ;;        ("C-c p f" . cape-file)
    ;;        ...)
    :init
    ;; Add to the global default value of `completion-at-point-functions' which is
    ;; used by `completion-at-point'.  The order of the functions matters, the
    ;; first function returning a result wins.  Note that the list of buffer-local
    ;; completion functions takes precedence over the global list.
    (add-hook 'completion-at-point-functions #'cape-dabbrev) ; Complete word from current buffer
    (add-hook 'completion-at-point-functions #'cape-file) ; Complete file name
    (add-hook 'completion-at-point-functions #'cape-elisp-block) ; Complete elisp in org-mode code block
    ;; (add-hook 'completion-at-point-functions #'cape-history)
    )
#+end_src

*** Orderless
#+begin_src elisp
  ;; Use the `orderless' completion style.
  (use-package orderless
    :ensure t
    :custom
    ;; Configure a custom style dispatcher (see the Consult wiki)
    ;; (orderless-style-dispatchers '(+orderless-consult-dispatch orderless-affix-dispatch))
    ;; (orderless-component-separator #'orderless-escapable-split-on-space)
    (completion-styles '(orderless basic))
    (completion-category-defaults nil)
    (completion-category-overrides '((file (styles partial-completion)))))
#+end_src

*** Marginalia
#+begin_src elisp
  (use-package marginalia
    :ensure t
    :init
    (marginalia-mode))
#+end_src

*** Dired
#+begin_src elisp
  (use-package dired
    :ensure nil

    :custom
    (dired-dwim-target t))
#+end_src

*** Powershell
Install package to edit powershell script with Emacs and execute powershell command from
org-mode source block.
#+begin_src elisp
  (use-package powershell
    :ensure t)

  (use-package ob-powershell
    :ensure t)
#+end_src

*** Org-mode
#+begin_src elisp
  (use-package org
    :ensure nil
    :bind ((("C-c l" . org-store-link)
            ("C-c a" . org-agenda)
            ("C-c d" . org-time-stamp-inactive) ;; Remap de C-c ! car masqué par flycheck
            ("C-c c" . org-capture)
            ("C-c b" . org-switchb)))

    :config
    ;; Initialize org-block and org-table to fixed-pitch
    (set-face-attribute 'org-block nil :foreground 'unspecified :inherit 'fixed-pitch)
    (set-face-attribute 'org-table nil :inherit 'fixed-pitch)

    (setq org-M-RET-may-split-line '((default . nil))) ; Doing M-RET when cursor is in middle of heading will not split line at current POS

    (setq org-todo-keywords
          '((sequence "TODO(t)" "IN-PROGRESS(i)" "WAITING(w)" "MAYBE(m)"  "|" "DONE(d)" "CANCEL(c)")))


    ;; Initialisation de org-babel
    (org-babel-do-load-languages
     'org-babel-load-languages
     '((emacs-lisp . t)
       (powershell . t)
       (org . t)
       ;; (restclient . t)
       ;;(plantuml . t)
       ))


    :custom
    ;; Setup custom variable for org-mode
    (org-insert-heading-respect-content t)

    (org-directory "~/Documents/Org")
    (org-archive-location "./Archives/%s_archive::")
    (org-agenda-files
     '("~/Documents/Org/Todo.org"))

    (org-log-done t)                      ; Log when a task is done
    (org-startup-indented t)              ; Indent text according to outline structure
    (org-startup-with-inline-images t)    ; Display inline image by default
    (org-src-tab-acts-natively t)
    (org-image-actual-width '(600)))      ; Image default size
#+end_src

**** Org-duration
Change default duration for clock :
- 1h = 60 min
- Work average 8h/day
- 5 days per week
- 4 weeks/month
- 10 month/year

#+begin_src elisp
  (use-package org-duration
    :ensure nil
    :config
    (customize-set-variable
     'org-duration-units
     `(("min" . 1)
       ("h" . 60)
       ("d" . ,(* 60 8))
       ("w" . ,(* 60 8 5))
       ("m" . ,(* 60 8 5 4))
       ("y" . ,(* 60 8 5 4 10)))))
#+end_src

*** Org-roam
I do not used org-roam yet.
#+begin_src elisp :tangle no
  (use-package org-roam
    :after (org)
    :ensure t
    :custom
    (org-roam-database-connector 'sqlite-builtin)

    (org-roam-directory "~/Documents/Org/roam-notes")
    :bind (("C-c n l" . org-roam-buffer-toggle)
           ("C-c n f" . org-roam-node-find)
           ("C-c n i" . org-roam-node-insert))
    :config
    (org-roam-db-autosync-enable))
#+end_src

*** Org-superagenda
#+begin_src elisp
  (use-package org-super-agenda
    :after (org)
    :ensure t
    :config
    (org-super-agenda-mode))
#+end_src

*** Which-key
Display available keybindings.
#+begin_src elisp
  (use-package which-key
    :ensure t
    :config
    (which-key-mode))
#+end_src

*** Terminal and shell
Use =eat= terminal emulator when running macosx.
#+begin_src elisp
  (use-package eat
    :if (memq window-system '(mac ns))
    :ensure t
    :hook
    (eshell-load . eat-eshell-mode)
    ;; (eshell-load . eat-eshell-visual-command-mode)
    )
#+end_src

*** Code editing
For this part, i found various info on different blogs :
- Ovi Stoica's blog [[https://www.ovistoica.com/blog/2024-7-05-modern-emacs-typescript-web-tsx-config][modern emacs typescript web config]]
-

**** Tree-sitter

[[https://tree-sitter.github.io]]

Tree-sitter is builtin starting Emacs 29.

To use tree-sitter on windows, you need a C compiler to compile language's
grammar. You can install =gcc= with MSYS2 and modify your PATH accordingly.

You can check if the compiler is found directly in emacs by executing this command :
#+begin_src elisp :tangle no
  M-: (executable-find "gcc")
#+end_src

#+RESULTS:
: c:/msys64/mingw64/bin/gcc.exe

To install a grammar. You must call :
#+begin_src elisp :tangle no
  M-x treesit-install-language-grammar
#+end_src

You can then type the language (ex: typescript). If there is no recipe to
compile the grammar directly, emacs will prompt you all the questions to
download and compile the grammar.

The following config was taken from

#+begin_src elisp
  (use-package treesit
    :mode (("\\.tsx\\'" . tsx-ts-mode)
           ("\\.js\\'"  . typescript-ts-mode)
           ("\\.mjs\\'" . typescript-ts-mode)
           ("\\.mts\\'" . typescript-ts-mode)
           ("\\.cjs\\'" . typescript-ts-mode)
           ("\\.ts\\'"  . typescript-ts-mode)
           ("\\.jsx\\'" . tsx-ts-mode)
           ("\\.json\\'" . json-ts-mode)
           ;; More modes defined here...
           )
    :preface
    (defun os/setup-install-grammars ()
      "Install Tree-sitter grammars if they are absent."
      (interactive)
      (dolist (grammar
               '((css . ("https://github.com/tree-sitter/tree-sitter-css" "v0.23.2"))
                 (html . ("https://github.com/tree-sitter/tree-sitter-html" "v0.23.2"))
                 (javascript . ("https://github.com/tree-sitter/tree-sitter-javascript" "v0.23.1" "src"))
                 (json . ("https://github.com/tree-sitter/tree-sitter-json" "v0.24.8"))
                 (tsx . ("https://github.com/tree-sitter/tree-sitter-typescript" "v0.23.1" "tsx/src"))
                 (typescript . ("https://github.com/tree-sitter/tree-sitter-typescript" "v0.23.1" "typescript/src"))
                 ))

        (add-to-list 'treesit-language-source-alist grammar)
        ;; Only install `grammar' if we don't already have it
        ;; installed. However, if you want to *update* a grammar then
        ;; this obviously prevents that from happening.
        (unless (treesit-language-available-p (car grammar))
          (treesit-install-language-grammar (car grammar)))))

    ;; Optional, but recommended. Tree-sitter enabled major modes are
    ;; distinct from their ordinary counterparts.
    ;;
    ;; You can remap major modes with `major-mode-remap-alist'. Note
    ;; that this does *not* extend to hooks! Make sure you migrate them
    ;; also
    (dolist (mapping
             '((css-mode . css-ts-mode)
               (typescript-mode . typescript-ts-mode)
               (js-mode . typescript-ts-mode)
               (js2-mode . typescript-ts-mode)
               (json-mode . json-ts-mode)
               (js-json-mode . json-ts-mode)))
      (add-to-list 'major-mode-remap-alist mapping))
    :config
    (os/setup-install-grammars))
#+end_src

**** Lsp mode
Enable lsp-mode for code editing.

#+begin_src elisp
  (use-package lsp-mode
    :init
    ;; set prefix for lsp-command-keymap (few alternatives - "C-l", "C-c l")
    (setq lsp-keymap-prefix "C-c l")
    (setq lsp-idle-delay 0.500)
    :hook (
           (tsx-ts-mode
            typescript-ts-mode
            js-ts-mode
            ) . lsp)
    ;; if you want which-key integration
    (lsp-mode . lsp-enable-which-key-integration)
    :commands lsp)

  (use-package lsp-ui :commands lsp-ui-mode)

  ;; lsp-mode client for eslint
  (use-package lsp-eslint
    :demand t
    :after lsp-mode)

  ;; The lsp-mode client for tailwindcss
  (use-package lsp-tailwindcss
    :after lsp-mode
    :init (setq lsp-tailwindcss-add-on-mode t)
    :config
    (dolist (tw-major-mode
             '(css-mode
               css-ts-mode
               typescript-mode
               typescript-ts-mode
               tsx-ts-mode
               js2-mode
               js-ts-mode))
      (add-to-list 'lsp-tailwindcss-major-modes tw-major-mode)))
#+end_src

**** Company

#+begin_src elisp
   (use-package company
     :defer 0.5
     :delight
     :custom
     (company-begin-commands '(self-insert-command))
     (company-idle-delay .1)
     (company-minimum-prefix-length 2)
     (company-show-numbers t)
     (company-tooltip-align-annotations 't)
     ;; (global-company-mode t)
     )

   (setq lsp-prefer-capf t)
#+end_src

#+RESULTS:
: t

#+begin_src elisp
(use-package company-box
  :hook (company-mode . company-box-mode))
#+end_src


**** Treemacs

#+begin_src elisp
  (use-package treemacs
    :ensure t
    :defer t
    :init
    (setq treemacs-python-executable (executable-find "python"))
    (with-eval-after-load 'winum
      (define-key winum-keymap (kbd "M-0") #'treemacs-select-window))
    :config
    (progn
      (setq treemacs-buffer-name-function            #'treemacs-default-buffer-name
            treemacs-buffer-name-prefix              " *Treemacs-Buffer-"
            treemacs-collapse-dirs                   (if treemacs-python-executable 3 0)
            treemacs-deferred-git-apply-delay        0.5
            treemacs-directory-name-transformer      #'identity
            treemacs-display-in-side-window          t
            treemacs-eldoc-display                   'simple
            treemacs-file-event-delay                2000
            treemacs-file-extension-regex            treemacs-last-period-regex-value
            treemacs-file-follow-delay               0.2
            treemacs-file-name-transformer           #'identity
            treemacs-follow-after-init               t
            treemacs-expand-after-init               t
            treemacs-find-workspace-method           'find-for-file-or-pick-first
            treemacs-git-command-pipe                ""
            treemacs-goto-tag-strategy               'refetch-index
            treemacs-header-scroll-indicators        '(nil . "^^^^^^")
            treemacs-hide-dot-git-directory          t
            treemacs-hide-dot-jj-directory           t
            treemacs-indentation                     2
            treemacs-indentation-string              " "
            treemacs-is-never-other-window           nil
            treemacs-max-git-entries                 5000
            treemacs-missing-project-action          'ask
            treemacs-move-files-by-mouse-dragging    t
            treemacs-move-forward-on-expand          nil
            treemacs-no-png-images                   nil
            treemacs-no-delete-other-windows         t
            treemacs-project-follow-cleanup          nil
            treemacs-persist-file                    (expand-file-name ".cache/treemacs-persist" user-emacs-directory)
            treemacs-position                        'left
            treemacs-read-string-input               'from-child-frame
            treemacs-recenter-distance               0.1
            treemacs-recenter-after-file-follow      nil
            treemacs-recenter-after-tag-follow       nil
            treemacs-recenter-after-project-jump     'always
            treemacs-recenter-after-project-expand   'on-distance
            treemacs-litter-directories              '("/node_modules" "/.venv" "/.cask")
            treemacs-project-follow-into-home        nil
            treemacs-show-cursor                     nil
            treemacs-show-hidden-files               t
            treemacs-silent-filewatch                nil
            treemacs-silent-refresh                  nil
            treemacs-sorting                         'alphabetic-asc
            treemacs-select-when-already-in-treemacs 'move-back
            treemacs-space-between-root-nodes        t
            treemacs-tag-follow-cleanup              t
            treemacs-tag-follow-delay                1.5
            treemacs-text-scale                      nil
            treemacs-user-mode-line-format           nil
            treemacs-user-header-line-format         nil
            treemacs-wide-toggle-width               70
            treemacs-width                           35
            treemacs-width-increment                 1
            treemacs-width-is-initially-locked       t
            treemacs-workspace-switch-cleanup        nil)

      ;; The default width and height of the icons is 22 pixels. If you are
      ;; using a Hi-DPI display, uncomment this to double the icon size.
      ;;(treemacs-resize-icons 44)

      (treemacs-follow-mode t)
      (treemacs-filewatch-mode t)
      (treemacs-fringe-indicator-mode 'always)
      (when treemacs-python-executable
        (treemacs-git-commit-diff-mode t))

      (pcase (cons (not (null (executable-find "git")))
                   (not (null treemacs-python-executable)))
        (`(t . t)
         (treemacs-git-mode 'deferred))
        (`(t . _)
         (treemacs-git-mode 'simple)))

      (treemacs-hide-gitignored-files-mode nil))
    :bind
    (:map global-map
          ("M-0"       . treemacs-select-window)
          ("C-x t 1"   . treemacs-delete-other-windows)
          ("C-x t t"   . treemacs)
          ("C-x t d"   . treemacs-select-directory)
          ("C-x t B"   . treemacs-bookmark)
          ("C-x t C-t" . treemacs-find-file)
          ("C-x t M-t" . treemacs-find-tag)))

  ;; (use-package treemacs-evil
  ;;   :after (treemacs evil)
  ;;   :ensure t)

  (use-package treemacs-projectile
    :after (treemacs projectile)
    :ensure t)

  ;; (use-package treemacs-icons-dired
  ;;   :hook (dired-mode . treemacs-icons-dired-enable-once)
  ;;   :ensure t)

  (use-package treemacs-magit
    :after (treemacs magit)
    :ensure t)

  ;; (use-package treemacs-persp ;;treemacs-perspective if you use perspective.el vs. persp-mode
  ;;   :after (treemacs persp-mode) ;;or perspective vs. persp-mode
  ;;   :ensure t
  ;;   :config (treemacs-set-scope-type 'Perspectives))

  ;; (use-package treemacs-tab-bar ;;treemacs-tab-bar if you use tab-bar-mode
  ;;   :after (treemacs)
  ;;   :ensure t
  ;;   :config (treemacs-set-scope-type 'Tabs))

  ;; (treemacs-start-on-boot)
#+end_src

#+RESULTS:

*** Prettier

#+begin_src elisp
  (use-package prettier-js
  :ensure t
  :ensure-system-package (prettier . "npm i -g prettier")
  :hook ((typescript-ts-mode . prettier-js-mode)
         (js-ts-mode . prettier-js-mode)
         (web-mode . prettier-js-mode)
         (css-mode . prettier-js-mode)
         (tsx-ts-mode . prettier-js-mode)))
#+end_src


** EOF
#+begin_src elisp
  (provide 'init)
  ;;; init.el ends here
#+end_src
